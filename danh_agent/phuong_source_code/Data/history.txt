#########################
TR #24981 ibcf: Too many fields of kind 21 encountered

Auto test #25570

1) SIP message received with more than 10 Allow headers

...
(05:51:19.50) W0 in <192.168.37.94:4002> <- 1848 bytes from <192.168.37.21:7888>
INVITE sip:49421554717@10.208.178.81:4002 SIP/2.0
To: sip:+49421554717@10.208.178.81;user=phone;tag=sip+3+b2650010+2028badd+BIACTGQ
From: sip:+4942169622815@nica.ewetel.de;user=phone;tag=01449-TK-033f2868-65ca67f87
Via: SIP/2.0/UDP 192.168.37.21:7888;branch=z9hG4bK-1504886-1-1
Call-ID: 1-1504886@192.168.37.21
CSeq: 1 INVITE
Contact: <sip:192.168.37.21:7888>
Route: <sip:192.168.37.94:4002;lr>
Supported: histinfo
Max-Forwards: 70
Content-Type: application/sdp
Content-Length:   259
Allow: REGISTER
Allow: REFER
Allow: NOTIFY
Allow: SUBSCRIBE
Allow: INFO
Allow: PRACK
Allow: UPDATE
Allow: INVITE
Allow: ACK
Allow: OPTIONS
Allow: CANCEL
Allow: BYE
Min-SE: 900
Session-Expires: 1800
P-User-Database: <aaa://HNO-SHSA001.tel.t-online.de>
Session-ID: a80430f1eec136ee620ddab209173840;remote=00000000000000000000000000000000
Accept: application/dtmf-relay
Accept: application/emergencycall.providerinfo+xml
Accept: application/emergencycalldata.providerinfo+xml
Accept: application/media_control+xml
Accept: application/pidf+xml
Accept: application/sdp
Accept: application/vnd.etsi.cug+xml
Accept: application/x-broadworks-call-center+xml
Accept: application/emergencycalldata.comment+xml
Accept: multipart/mixed
Accept: application/x-broadworks-conference-info+xml
History-Info: <sip:+4961529487698;npdi@telekom.de;user=phone?Privacy=history>;index=1
History-Info: <sip:+494473941222@telekom.de;user=phone;cause=302>;index=1.1
P-Asserted-Identity: <sip:+49930572035020@telekom.de;user=phone>
P-Asserted-Identity: <tel:+49930572035020>
P-Early-Media: supported
Privacy: none

v=0
o=cp10 116221159107 116221159108 IN IP4 192.168.37.21
s=SIP Call
c=IN IP4 192.168.37.21
t=0 0
m=audio 6350 RTP/AVP 0 18 8
b=AS:64
a=rtpmap:0 PCMU/8000/1
a=rtpmap:8 PCMA/8000/1
a=rtpmap:18 G729/8000/1
a=fmtp:18 annexb=no
a=ptime:20
a=sendrecv


(04:00:05.49) W0 FWD: ctx status INIT
(04:00:05.49) W0 Too many fields of kind 21 encountered. Indicating next ones as unknown
(04:00:05.49) W0 ProcessDiameterAccounting: in, TaxEnb=1
(04:00:05.49) W0 Too many fields of kind 21 encountered. Indicating next ones as unknown
(04:00:05.49) W0 Too many fields of kind 21 encountered. Indicating next ones as unknown


=> In the forwarded message, all "Allow" headers are included but some processing is probably not done/considered on the items over the 10th one.


Step 1: Get the ibcf binary version 7.2.51

Step 2: Get the basic call sipp scenarial

Step 3: Modify header initial INVITE the same as provided INVITE message

Step 4: Make the basic call between ibcf

Step 5: Checking the log "Too many fields of kind 21 encountered. Indicating next ones as unknown"


############################################
TR #25565 [SBC 7.2]: ibcf proxy detects Allow Header occurence limit yet doesn't reject call and applies HMR and has call pass by normally 


PCSCF has Call rejected with "500 Internal Server Error" Error code 
While IBCF detects Allow header limit, but lets call run OK and applied HMR anyways: 

(11:38:18.57) W0 in <192.168.37.94:4402> <- 1776 bytes from <192.168.37.94:4408>
INVITE sip:0111013602@192.168.37.94:4402 SIP/2.0
To: Called <sip:0111013602@192.168.37.94>
From: Caller <sip:0111013601@192.168.37.94>;tag=1-1-1
Via: SIP/2.0/UDP 192.168.37.94:4408;branch=z9hG4bK-22851-1-1
Call-ID: 1-22851@192.168.37.94
CSeq: 1 INVITE
Contact: <sip:192.168.37.94:4408>
Route: <sip:192.168.37.94:4402;lr>
Supported: histinfo
Max-Forwards: 70
Allow: REGISTER
Allow: REGISTER
Allow: REGISTER
Allow: NOTIFY
Allow: REGISTER
Allow: INFO
Allow: PRACK
Allow: UPDATE
Allow: INVITE
Allow: ACK
Allow: OPTIONS
Allow: CANCEL
Allow: BYE
Allow: OPTIONS
Allow: CANCEL
Allow: BYE
Allow: OPTIONS
Allow: CANCEL
Allow: BYE
P-User-Database: <aaa://HNO-SHSA001.tel.t-online.de>
Session-ID: a80430f1eec136ee620ddab209173840;remote=00000000000000000000000000000000
Accept: application/dtmf-relay
Accept: application/emergencycall.providerinfo+xml
Accept: application/emergencycalldata.providerinfo+xml
Accept: application/media_control+xml
Accept: application/pidf+xml
Accept: application/sdp
Accept: application/vnd.etsi.cug+xml
Accept: application/x-broadworks-call-center+xml
Accept: application/emergencycalldata.comment+xml
Accept: multipart/mixed
Accept: application/x-broadworks-conference-info+xml
P-Preferred-Identity: <sip:0182000000@10.255.35.177:5860>
History-Info: <sip:0182000000@10.255.35.177:5860>;index=1
History-Info: <sip:0182000000@10.255.35.177:5860>;index=1.1
P-Early-Media: supported
Privacy: none
Content-Type: application/sdp
Content-Length:   259

v=0
o=cp10 116221159107 116221159108 IN IP4 192.168.37.94
s=SIP Call
c=IN IP4 192.168.37.94
t=0 0
m=audio 6350 RTP/AVP 0 18 8
b=AS:64
a=rtpmap:0 PCMU/8000/1
a=rtpmap:8 PCMA/8000/1
a=rtpmap:18 G729/8000/1
a=fmtp:18 annexb=no
a=ptime:20
a=sendrecv


(12:47:21.57) W0 Too many fields of kind 21 encountered. Indicating next ones as unknown
(12:47:21.57) W5 Too many SIP fields encountered!!
(12:47:21.57) W2 S000001 Could not extract fields
...
(12:47:21.58) W0 SipFieldCopy: Allow
(12:47:21.58) W0 +++ memory   allocated = (@=0x7f2ed40930c0)-(0202 b)-(404) : "non brick header" 
(12:47:21.58) W0 +++ memory   allocated = (@=0x7f2ed4092ef0)-(0016 b)-(405) : "string node" 
(12:47:21.58) W0 matching value for : Allow: REGISTER, REGISTER, REGISTER, NOTIFY, REGISTER, INFO, PRACK, UPDATE, INVITE, ACK, OPTIONS, CANCEL, BYE, OPTIONS, CANCEL, BYE, OPTIONS, CANCEL, BYE

The issue here is why ibcf has different behaviour than pcscf while treating the same case? Why doesn't it reject call?


Step 1: Get the ibcf binary version 7.2.52

Step 2: Get the basic call sipp scenarial

Step 3: Modify header initial INVITE the same as provided INVITE message

Step 4: Make the basic call between ibcf

Step 5: Checking the log 
(12:47:21.57) W0 Too many fields of kind 21 encountered. Indicating next ones as unknown
(12:47:21.57) W5 Too many SIP fields encountered!!
(12:47:21.57) W2 S000001 Could not extract fields

#########################################
TR #26967 [SBC 7.2] [Regression] [IBCF] [PCSCF] HMR wrongly applied for Allow header
ibcf-7.2.52-70089.el7.x86_64


Test Information /context/ scenario : Issue found review SBC compact test suite in W#14. The Valid_6_4_23691_ibcf_HMR_del_allow.txt and Valid_6_4_23691_pcscf_HMR_del_allow.txt are failed

Config HMR to delete first field in Allow header

[PEER_valid_auto_ext]
SIP_MANIPULATION[] = SET_ALLOW
Authorization_profile = 0
#valid_auto_ext peer definition. Lines of kind <parameter_name>=<parameter_value>
Max_in = 65550
Max_out = 65550
Hiding = NO_HIDING
Media_Profile = 19
#Authorization_profile = 0
Routing_profile = 0
behavior = 7
Trusted = TRUE
Privacy = FALSE
Fields_Filtering = NONE
Domain[] = 192.168.33.33:5022

[ MANIPULATION_RULE_DEL-ALLOW-INSTANCE1 ]
Instance = "^"
Action_Type = Del
Element_Type = HEADER-VALUE
Header_Name = Allow


[ SIP_MANIPULATION_PROFILE_SET_ALLOW ]
Manipulation[] = DEL-ALLOW-INSTANCE1
Applicability = BOTH
Method_Type[] = "*"
Message_Type = BOTH
Strategy = IN

Make an incoming call to IBCF with Allow header
Expected result: HMR is applied, first fleld in allow is delete in INVITE send out

Actual result: HMR is applied, but the first field of allow header is not deleted, field order of allow header is changed in INVITE send out

(11:15:05.88) W0 in <192.168.33.157:5681> <- 809 bytes from <192.168.33.163:5022>
INVITE sip:0167000000@192.168.33.157:5681 SIP/2.0
To: Called <sip:0167000000@192.168.33.157>
From: Calling <sip:0166000000@192.168.33.163>;tag=1-1-1
Via: SIP/2.0/UDP 192.168.33.163:5022;branch=z9hG4bK-13293-1-1
Call-ID: 1-13293@192.168.33.163
CSeq: 1 INVITE
Contact: <sip:192.168.33.163:5022>
P-Asserted-Identity: <sip:0166000000@192.168.33.163:5022;user=phone>
Route: <sip:192.168.33.157:5681;lr>
Max-Forwards: 70
Allow: REFER,INVITE,INFO,ACK,SUBSCRIBE,UPDATE,REGISTER,BYE,CANCEL
Content-Type: application/sdp
Content-Length:   261

v=0
o=cp10 116221159107 116221159108 IN IP4 192.168.33.163
s=SIP Call
c=IN IP4 192.168.33.163
t=0 0
m=audio 6350 RTP/AVP 0 18 8
b=AS:64
a=rtpmap:0 PCMU/8000/1
a=rtpmap:8 PCMA/8000/1
a=rtpmap:18 G729/8000/1
a=fmtp:18 annexb=no
a=ptime:20
a=sendrecv


(11:15:05.90) W0 pre-process: peer <valid_auto_ext>
(11:15:05.90) W0 S000004 setting peer state to PREPROCESS_DONE
(11:15:05.90) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(11:15:05.90) W0 ipg: 192.168.33.163 is an IP v4
(11:15:05.90) W0 Transaction is matching the Matching Rules - Going to Apply Manipulation Rules
(11:15:05.90) W0 Apply Manipulation Rule DEL-ALLOW-INSTANCE1


(11:15:05.95) W0 out <192.168.33.157:5686> -> 1132 bytes to <192.168.33.163:5044>
INVITE sip:0167000000@192.168.33.157:5681 SIP/2.0
Call-ID: 1-13293@192.168.33.163
Contact: <sip:192.168.33.163:5022>
Content-Type: application/sdp
CSeq: 1 INVITE
From: Calling <sip:0166000000@192.168.33.163>;tag=1-1-1
Max-Forwards: 69
Record-Route: <sip:192.168.33.157:5686;user=00000004;lr;Cpkt=HKNTH;C=on-cirpack>
Route: <sip:192.168.33.163:5044;transport=udp;lr>
To: Called <sip:0167000000@192.168.33.157>
Via: SIP/2.0/UDP 192.168.33.157:5686;branch=z9hG4bK-HKNT-00000000-45aed1d5,SIP/2.0/UDP 192.168.33.157:5681;emission,SIP/2.0/UDP 192.168.33.163:5022;received=192.168.33.163;rport=5022;branch=z9hG4bK-13293-1-1
P-Asserted-Identity: <sip:0166000000@192.168.33.163:5022;user=phone>
Allow: BYE,CANCEL,INFO,INVITE,REFER,REGISTER,SUBSCRIBE,UPDATE



Step 1: Get the ibcf binary version 7.2.52

Step 2: Get the basic call sipp scenarial

Step 3: Modify header initial INVITE the same as provided INVITE message

Step 4: Config HMR to delete first field in Allow header

Step 4: Make the basic call between ibcf

Step 5: Checking out going INVITE allow header is deleted not the first 'allow' value

#######################################################
#24628  ibcf does not apply HMR to HIH exceeding 1024 characters - W5 string too long
ibcf 7.2.60 :


1) Received INVITE from external peer (OK)

(08:14:09.41) W0 in <10.208.189.17:5060> <- 3991 bytes from <10.208.189.14:5060>
INVITE sip:+49D0781749490177@sipreg2.ewetel.de;user=phone SIP/2.0
Call-ID: fdbb820566c142ebe980de659c7ec103@10.208.189.40
Contact: <sip:+4944135012780@10.208.189.40:5060>
Content-Type: application/sdp
CSeq: 7 INVITE
From: <sip:+4944135012780@sipreg2.voice.ewetel.de;user=phone>;tag=33038721_09ba9498_2bc2794a-788a-4b33-bf00-64d448102706
Max-Forwards: 63
Record-Route: <sip:10.208.189.14:5060;user=i0o0S000005b7;lr;Cpkt=CNMKV;C=on-cirpack>
Route: <sip:10.208.189.17:5060;transport=udp;lr>,<sip:ims1p1.nica.ewetel.de;transport=udp;lr>
Supported: 100rel,replaces
To: <sip:+4944180002461@nplcrnat.osp.voice.ewetel.de>
Via: SIP/2.0/UDP 10.208.189.14:5060;branch=z9hG4bK-CNMK-000010d4-198d2a4d,SIP/2.0/UDP 10.208.189.40:5060;received=10.208.189.40;rport=5060;branch=z9hG4bK2bc2794a-788a-4b33-bf00-64d448102706_09ba9498_7827518534571509
Accept: application/sdp,multipart/mixed
Accept-Encoding: identity
Allow: INVITE,BYE,ACK,OPTIONS,CANCEL,INFO,PRACK,SUBSCRIBE,NOTIFY,REFER,UPDATE,MESSAGE,PUBLISH
Allow-Events: telephone-event,refer
Expires: 120
User-Agent: AVM FRITZ!Box 7590 154.07.29 (Oct 26 2021)
Session-ID: 05ef8fc121ed9814c6ad31e4cbe74262
P-Asserted-Identity: <sip:+4944135012780@sipreg2.voice.ewetel.de;user=phone>
History-info: <sip:+4944180007922@icscf-cl02.ims1.voice.ewetel.de?Privacy=history>;index=1
History-info: <sip:+49800376462401@sipreg3.voice.ewetel.de;user=phone?Privacy=history&Reason=SIP%3Bcause%3D302%3Btext%3D%22Unconditional%22>;index=1.1
History-info: <sip:+4944136111397@unknown.invalid;cause=380;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D486&Privacy=history>;index=1.1.1;mp=1.1
History-info: <sip:+4944136111398@unknown.invalid;cause=486;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.2;mp=1.1
History-info: <sip:+4944136111394@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D500&Privacy=history>;index=1.1.3;mp=1.1
History-info: <sip:+4944136111395@unknown.invalid;cause=404;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D500&Privacy=history>;index=1.1.4;mp=1.1
History-info: <sip:+494413900195@unknown.invalid;cause=404;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.5;mp=1.1
History-info: <sip:+4944139022692@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.6;mp=1.1
History-info: <sip:+494413900197@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.7;mp=1.1
History-info: <sip:+4944139022733@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.8;mp=1.1
History-info: <sip:+4944139063182@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.9;mp=1.1
History-info: <sip:+4944199869416@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.10;mp=1.1
History-info: <sip:+4944199869425@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Reason=SIP%3Bcause%3D487&Privacy=history>;index=1.1.11;mp=1.1
History-info: <sip:+4944199869427@unknown.invalid;cause=487;user=phone;target=sip:+49800376462401%40unknown.invalid?Privacy=history>;index=1.1.12;mp=1.1
Content-Length: 376



2) HMR not applied (NOK)

(08:14:09.42) W0 post-process: peer <ims1p1.b.ibcf-lab.ims1p1.nica.ewetel.de>
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 SipFieldCopy: History-info
(08:14:09.42) W5 Header History-info : string too long, size=2204, max size=1024
(08:14:09.42) W0 Apply matching rule HIH_del_REID : false
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 matching value for : +4944180002461
(08:14:09.42) W0 Apply matching rule TO_del_REID : false
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 SipFieldCopy: History-info
(08:14:09.42) W5 Header History-info : string too long, size=2204, max size=1024
(08:14:09.42) W0 Apply matching rule HIH_del_PIDD1 : false
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 matching value for : +4944180002461
(08:14:09.42) W0 Apply matching rule TO_del_PIDD1 : false
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 matching value for : +4944180002461
(08:14:09.42) W0 Apply matching rule TO_del_LCR : false
(08:14:09.42) W0 Transaction is matching the Manipulation Profile - Going to Apply Matching_Rules
(08:14:09.42) W0 SipFieldCopy: History-info
(08:14:09.42) W5 Header History-info : string too long, size=2204, max size=1024




Step 1: Get the ibcf binary version 7.2.60

Step 2: Get the basic call sipp scenarial

Step 3: Modify header initial INVITE the same as provided INVITE message

Step 4: Config HMR to delete HIH

Step 4: Make the basic call between ibcf

Step 5: Checking error log:
W5 Header History-info : string too long, size=2204, max size=1024

##############################################
#26716 [SBC7.0] Matching Rule to detect To-tag in To header is not working
Tested also in 7.2 patch: ibcf.x86_64 7.2.65-70931.el7


The customer is applying a header authorization 

Due to German law our customers have to reject calls with 0900-numbers in the From-, PPI- and PAI-Header.

The implemented Header_Authorization_Filtering_Profile works well for the INVITE but now it rejects re-INVITEs, where the To and From headers are inversed.

So they need a Matching-Rule to to distinguish between INVITE and Re-INVITE.

Syserso tested several combinations in the Matching Rule, I tested as well lot of Matching Rule but we are always getting:

W0 Apply matching rule HAS_TO_TAG : false
 

Here are the tested Matching Rules:

 

[ MATCHING_RULE_HAS_TO_TAG ]
Header_Name = TO
Element_Type = HEADER-PARAM, tag
Condition_Type = NONE
Instance = "*"
Min_Occurrence = 1


[ MATCHING_RULE_HAS_TO_TAG ]
Header_Name = TO
Element_Type = HEADER-PARAM, tag
Condition_Type = NONE
Instance = "*"
Min_Occurrence = 1
Matching_Value = "(tag)(.*)"



[ MATCHING_RULE_HAS_TO_TAG ]
Header_Name = TO
Element_Type = HEADER-PARAM
Condition_Type = NONE
Instance = "*"
Min_Occurrence = 1
Matching_Value = "(tag)(.*)"


[ MATCHING_RULE_HAS_TO_TAG ]
Header_Name = TO
Element_Type = HEADER-PARAM-NAME, tag
Condition_Type = NONE
Instance = "*"
Min_Occurrence = 1


[ MATCHING_RULE_HAS_TO_TAG ]
Header_Name = TO
Element_Type = HEADER-PARAM-NAME
Condition_Type = NONE
Instance = "*"
Min_Occurrence = 1
Matching_Value = "(tag)(.*)"


The provided logs are for the first one, which is supposed to work well based on the documentation.


Step 1: Get the ibcf binary version 7.2.65

Step 2: Get the B-ReINVITe scenarial

Step 4: Config HMR to detect the 'to tag'

Step 4: Make the basic call between ibcf

Step 5: Checking for matching rule 'to tag'

##############################################
#26240 PAI header not matched by regex in Matching_Rule for ibcf
ibcf.x86_64                      7.0.120-70797.el7           @CIRPACK-sbc


Here is an extract from ibcf_dyn.cfg containing the concerned peer configuration:

===================================================================
[PEER_fidscha_BS]
#fidscha_BS peer definition. Lines of kind <parameter_name>=<parameter_value>
Max_in = 5
Max_out = 5
Max_both = 10
Hiding = HIDING
Authorization_profile = 2
Routing_profile = 0
Trusted = TRUE
Privacy = FALSE
Fields_Filtering = NONE
#SIP_MANIPULATION[] = del_gruu
#SIP_MANIPULATION[] = del_100rel
#SIP_MANIPULATION[] = del_supported
#SIP_MANIPULATION[] = Add_rn_param
#SIP_MANIPULATION[] = HIH_del_AAA
#SIP_MANIPULATION[] = HIH_del_AAA_2
#SIP_MANIPULATION[] = HIH_del_AAA_3
Domain[] = 192.168.130.6:5060
Domain[] = 192.168.130.6:5073
Domain[] = 192.168.148.17:5060

[AUTHORIZATION_PROFILE_2]
#<method>=<behavior> [, <return_code>]
DEFAULT = Reject, 405
INVITE = Accept
OPTIONS = Reject, 200
BYE = Accept
CANCEL = Accept
REGISTER = Reject, 405
INFO = Reject, 405
MESSAGE = Reject, 405
NOTIFY = Reject, 405
PRACK = Accept
PUBLISH = Reject, 405
REFER = Reject, 405
SUBSCRIBE = Reject, 405
UPDATE = Accept
Header_Authorization_Filtering_Profile[] = TKG120

[Header_Authorization_Filtering_Profile_TKG120]
Method_Type = INVITE
Policy = REJECT
Return_code = 403
Matching_Rules = (TKG120_PAI)

[ MATCHING_RULE_TKG120_PAI ]
Header_Name = P-Asserted-Identity
Element_Type = URI-USER
Condition_Type = NONE
Instance = "^"
Min_Occurrence = 1
Matching_Value = "^((11[028])|(0137)|(0900)|(\+49137)|(\+49900)|(\+4917621223346)|(017621223346))"
===================================================================

The regex present in the Matching_Rule above matches (amongst others) strings containing "+4917621223346".


They performed two tests, the INVITE from the 1st test contains the following headers:

    (09:11:16.71) W0 in <192.168.148.11:5060> <- 1000 bytes from <192.168.130.6:5060>
    INVITE sip:+49511220669123003@192.168.146.22:5060 SIP/2.0
    P-Asserted-Identity: <sip:+4917621223346;cpc=mobile-hplmn@telekom.de;user=phone>
    P-Asserted-Identity: <tel:+4917621223346;cpc=mobile-hplmn>

-> The PAI should match the mentioned regex, but it is not the case according to ibcf.1 logs:

===================================================================
(09:11:16.71) W0 pre-process: peer <fidscha_BS>
(09:11:16.71) W0 S000165 setting peer state to PREPROCESS_DONE
(09:11:16.71) W0 post-process: peer <fidscha_BS>
(09:11:16.71) W0 Apply Header_authorization_filtering_profile_TKG120
(09:11:16.71) W0 ipg: 192.168.130.6 is an IP v4
(09:11:16.71) W0 Reject : <sip:+4917621223346;cpc=mobile-hplmn@telekom.de;user=phone> because its host is invalid
===================================================================

--------

Using the same configuration file, the INVITE from the 2nd test contains the following headers:

    (09:13:05.04) W0 in <192.168.148.11:5060> <- 983 bytes from <192.168.130.6:5060>
    INVITE sip:+49511220669123003@192.168.146.22:5060 SIP/2.0
    P-Asserted-Identity: <sip:+4917621223346@telekom.de;user=phone>
    P-Asserted-Identity: <tel:+4917621223346;cpc=mobile-hplmn>

In this case, the PAI matches the regex mentioned above and the call is rejected as expected:

===================================================================
(09:13:05.04) W0 pre-process: peer <fidscha_BS>
(09:13:05.04) W0 S000166 setting peer state to PREPROCESS_DONE
(09:13:05.04) W0 [S000166] forwarding to BGCF [192.168.146.22]:5060
(09:13:05.04) W0 S000166 peer behavior is 0
(09:13:05.04) W0 post-process: peer <fidscha_BS>
(09:13:05.04) W0 Apply Header_authorization_filtering_profile_TKG120
(09:13:05.04) W0 ipg: 192.168.130.6 is an IP v4
(09:13:05.04) W0 SipFieldCopy: P-Asserted-Identity
(09:13:05.04) W0 matching value for : +4917621223346
(09:13:05.04) W0 applyMatchingRule: matchingCount=1
(09:13:05.04) W0 Apply matching rule TKG120_PAI : true
(09:13:05.04) W0 S000166 Rejecting request due to peer policy
===================================================================

-> So it appears that the behavior differs depending on the fact that the PAI contains "cpc=mobile-hplmn" or not, which should not be the case.








-	Config HMR in IBCF the same as config file attached in this unit test.
-	Send INVITE with 2 PAI.


Validate:




1) SIP message received in live HTP SBC (described in file "call-details_2025-01-29_15_38_25_aZTPpcNevkTCvi8qSC1_wEw1vWY&#x3D_.html" but no Cirpack debug logs are available): 

INVITE sip:+4953123458050;npdi;rn=+49D32153123458050@htp-ngn.de;user=phone SIP/2.0
Via: SIP/2.0/UDP 87.136.5.66:5060;branch=z9hG4bK+c16ee7a669d0a28336f845abd895c3443+BIABNCY+5+a70f4a7b
From: <sip:+49531338532@telekom.de;user=phone>;tag=87.136.5.66+5+4451b0e9+7aeeb1c8+BIABNCY
To: <sip:+4953123458050@telekom.de;user=phone>
CSeq: 422667219 INVITE
Expires: 180
Route: <sip:htp-ngn.de;lr>
Content-Length: 2610
Supported: timer,199, 100rel
Contact: <sip:09DFF8DE94A060C9-BIABNCY@87.136.5.66:5060;transport=udp;lr>
Record-Route: <sip:09DFF8DE94A060C9-BIABNCY@87.136.5.66:5060;transport=udp;lr>
Content-Type: multipart/mixed; boundary="UniqueBroadWorksBoundary"
Call-ID: cb09dc14e6ed691303a16ee39c3e2658@87.136.5.66
P-Asserted-Identity: <sip:+49531338532@telekom.de;user=phone>
P-Asserted-Identity: <tel:+49531338532>
History-Info: <sip:+49198253131@telekom.de;user=phone?Reason=SIP%3bcause%3d480%3btext%3d%22Temporarily%20Unavailable%22%2cDiversion%3btext%3d%22unavailable%22>;index=1
History-Info: <sip:+4953123458050@telekom.de;user=phone;cause=503>;index=1.1
Call-Info: <cid:lisaprovider.z9hG4bKmavodi-0-155-0-1-e0520000-74b90000-6217ae9ffdf5f-a0c-ffffffffffffffff-276dbc9f7d93ee38@LSMMUN01>;purpose=emergencyCallData.ProviderInfo
Allow: ACK
Allow: BYE
Allow: CANCEL
Allow: INFO
Allow: INVITE
Allow: OPTIONS
Allow: PRACK
Allow: REFER
Allow: NOTIFY
Allow: UPDATE
X-BroadWorks-Correlation-Info: e0b292f2-970d-4922-8e66-fc017baf2ccc
Accept: application/dtmf-relay
Accept: application/emergencycall.providerinfo+xml
Accept: application/emergencycalldata.comment+xml
Accept: application/emergencycalldata.control+xml
Accept: application/emergencycalldata.ecall.msd
Accept: application/emergencycalldata.providerinfo+xml
Accept: application/media_control+xml
Accept: application/pidf+xml
Accept: application/sdp
Accept: application/vnd.etsi.cug+xml
Accept: application/x-broadworks-call-center+xml
Accept: multipart/mixed
Accept: application/x-broadworks-conference-info+xml
User-to-User: 001d05308301f684ffff48616e732d536f6d6d65722d5374722e;purpose=isdn-uui;encoding=hex
Geolocation-Routing: no
Geolocation: <cid:callerloc.z9hG4bKmavodi-0-155-0-1-e0520000-74b90000-6217ae9ffdf5f-a0c-ffffffffffffffff-276dbc9f7d93ee38@LSMMUN01>;loc-src=telekom.de
Session-ID: c72bbb1ae9331dd46275613364623832
Min-SE: 900
Session-Expires: 1800;refresher=uac
Max-Forwards: 66
MIME-Version: 1.0
P-Early-Media: supported
Privacy: none
 
On receipt of this INVITE, ibcf issues following log messages:

(15:06:45.73) W5 Too many SIP fields encountered!!
(15:06:45.73) W5 Too many SIP fields encountered!!
(15:06:45.73) W5 Too many SIP fields encountered!!
As this is quite complicated to duplicate this scenario at HTP on live platform to enable debug trace (this call-flow does not happen very often), Syserso has tried to reproduce it in lab with following SIP INVITE:

2) SIP message received in lab Syserso SBC (described in file ibcf.1 ):

(14:21:02.83) W0 in <192.168.148.11:5060> <- 4488 bytes from <192.168.148.17:5062>
INVITE sip:+49511220669500@192.168.148.11:5060;user=phone SIP/2.0
Via: SIP/2.0/UDP 192.168.148.17:5062;branch=SBC-multipart
From: Paula <sip:+4951122066994@192.168.148.17:5062>;tag=SIPpTag001
To: sut <sip:+49511220669500@192.168.148.11:5060>
Call-ID: SS_multipart_IV@192.168.130.6
Record-Route: <sip:192.168.148.17:5062;lr>
CSeq: 2 INVITE
Contact: sip:+4951122066994@192.168.148.17:5062
Expires: 180
Route: <sip:htp-ngn.de;lr>
Supported: timer,199, 100rel
Content-Type: multipart/mixed; boundary="UniqueBroadWorksBoundary"
P-Asserted-Identity: <sip:+4951122066994@telekom.de;user=phone>
P-Asserted-Identity: <tel:+4951122066994>
Call-Info: <cid:lisaprovider.z9hG4bKmavodi-0-155-0-1-e0520000-74b90000-6217ae9ffdf5f-a0c-ffffffffffffffff-276dbc9f7d93ee38@LSMMUN01>;purpose=emergencyCallData.ProviderInfo
Allow: ACK
Allow: BYE
Allow: CANCEL
Allow: INFO
Allow: INVITE
Allow: OPTIONS
Allow: PRACK
Allow: REFER
Allow: NOTIFY
Allow: UPDATE
X-BroadWorks-Correlation-Info: e0b292f2-970d-4922-8e66-fc017baf2ccc
Accept: application/dtmf-relay
Accept: application/emergencycall.providerinfo+xml
Accept: application/emergencycalldata.comment+xml
Accept: application/emergencycalldata.control+xml
Accept: application/emergencycalldata.ecall.msd
Accept: application/emergencycalldata.providerinfo+xml
Accept: application/media_control+xml
Accept: application/pidf+xml
Accept: application/sdp
Accept: application/vnd.etsi.cug+xml
Accept: application/x-broadworks-call-center+xml
Accept: multipart/mixed
Accept: application/x-broadworks-conference-info+xml
Accept: application/additional-1
Accept: application/additional-2
User-to-User: 001d05308301f684ffff48616e732d536f6d6d65722d5374722e;purpose=isdn-uui;encoding=hex
Geolocation-Routing: no
Geolocation: <cid:callerloc.z9hG4bKmavodi-0-155-0-1-e0520000-74b90000-6217ae9ffdf5f-a0c-ffffffffffffffff-276dbc9f7d93ee38@LSMMUN01>;loc-src=telekom.de
Session-ID: c72bbb1ae9331dd46275613364623832
Min-SE: 900
Session-Expires: 1800;refresher=uac
Max-Forwards: 66
MIME-Version: 1.0
P-Early-Media: supported
Privacy: none
Content-Length:  2368

--UniqueBroadWorksBoundary
Content-Length: 357
Content-Type: application/sdp

On receipt of such SIP INVITE, ibcf triggers following error logs ad rejects the call with SIP 500 release cause:

(14:21:02.83) W5 Too many SIP fields encountered!!
(14:21:02.83) W2 [S000037] Could not extract fields
Even if in both cases, the SIP INVITE are rejected with the same error logs, the root cause is not necessarily the same

3.       Expected behavior and reference (RFC, doc, specâ€¦)

ibcf must accept such SIP INVITE



ibcf.x86_64 7.2.162-74969.el7 
